@startuml
-> AbstractPlatformTransactionManager: suspend(Object transaction)
activate AbstractPlatformTransactionManager #DarkSalmon

note left of AbstractPlatformTransactionManager #FAEBD7
    *暂定(挂起)给定的事务
        ---模板方法调用实现以DataSourceTransactionManager为例
        ---这里只描述了主要步骤
end note

    alt 当前线程存在事务同步处理类
        note right of AbstractPlatformTransactionManager #aqua
            1.获取当前线程绑定的TransactionSynchronization，并逐一执行其suspend()进行挂起
            2.从当前线程中解除给定键的资源绑定及其他描述信息（事务名称，只读表示，隔离级别等），
                并包装成SuspendedResourcesHolder返回
        end note

        alt 存在事务
            AbstractPlatformTransactionManager -> DataSourceTransactionManager : doSuspend()
            activate DataSourceTransactionManager #DarkSalmon

                DataSourceTransactionManager -> TransactionSynchronizationManager : unbindResource()
                activate TransactionSynchronizationManager #DarkSalmon
                TransactionSynchronizationManager --> DataSourceTransactionManager : Object
                deactivate TransactionSynchronizationManager

            DataSourceTransactionManager --> AbstractPlatformTransactionManager : Object
            deactivate DataSourceTransactionManager
        end

    else 存在事务，且不需要同步
        note right of AbstractPlatformTransactionManager #aqua
            1.绑定的资源置为null。
            2.从当前线程中解除给定键的资源绑定，并包装成SuspendedResourcesHolder返回
        end note

        AbstractPlatformTransactionManager -> DataSourceTransactionManager : doSuspend()
        activate DataSourceTransactionManager #DarkSalmon

            DataSourceTransactionManager -> TransactionSynchronizationManager : unbindResource()
            activate TransactionSynchronizationManager #DarkSalmon
            TransactionSynchronizationManager --> DataSourceTransactionManager : Object
            deactivate TransactionSynchronizationManager

        DataSourceTransactionManager --> AbstractPlatformTransactionManager : Object
        deactivate DataSourceTransactionManager
    else
<-- AbstractPlatformTransactionManager: null
    end


<-- AbstractPlatformTransactionManager: suspendedResourcesHolder
deactivate AbstractPlatformTransactionManager

note right of AbstractPlatformTransactionManager #FAEBD7
    *总结
        1.挂起的意味着，从当前线程中解除绑定资源(connectionHolder)，就提交不了事务，达到了挂起的目的
        2.SuspendedResourcesHolder替代ThreadLocal,作为资源的持有者，返回给方法调用方
    *其它
        TransationSynchronization：Spring事务同步处理类

end note

@enduml