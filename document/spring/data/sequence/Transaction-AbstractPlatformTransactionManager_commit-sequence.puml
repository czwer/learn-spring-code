@startuml
-> AbstractPlatformTransactionManager: commit()
activate AbstractPlatformTransactionManager #DarkSalmon

note left of AbstractPlatformTransactionManager #FAEBD7
    *提交事务
        ---模板方法调用实现以DataSourceTransactionManager为例
        ---这里只描述了主要步骤
end note

    note right of AbstractPlatformTransactionManager #aqua
        1.必要时在transaction中绑定新获得的数据库连接
    end note

    alt 已将提交或回滚，不能重复操作
<-- AbstractPlatformTransactionManager : throw new IllegalTransactionStateException
    end

    alt 标记本地回滚
        AbstractPlatformTransactionManager -> AbstractPlatformTransactionManager : processRollback()
        activate AbstractPlatformTransactionManager #DarkSalmon
        deactivate AbstractPlatformTransactionManager
<-- AbstractPlatformTransactionManager
    end

    alt 标记全局回滚
        AbstractPlatformTransactionManager -> AbstractPlatformTransactionManager : processRollback()
        activate AbstractPlatformTransactionManager #DarkSalmon
        deactivate AbstractPlatformTransactionManager
<-- AbstractPlatformTransactionManager
    end

    AbstractPlatformTransactionManager -> AbstractPlatformTransactionManager : processCommit()
    activate AbstractPlatformTransactionManager #DarkSalmon
        AbstractPlatformTransactionManager -> AbstractPlatformTransactionManager : prepareForCommit()：准备提交---扩展点
        activate AbstractPlatformTransactionManager #DarkSalmon
        deactivate AbstractPlatformTransactionManager

        AbstractPlatformTransactionManager -> AbstractPlatformTransactionManager : triggerBeforeCommit()：触发提交前同步回调
        activate AbstractPlatformTransactionManager #DarkSalmon
        deactivate AbstractPlatformTransactionManager

        AbstractPlatformTransactionManager -> AbstractPlatformTransactionManager : triggerBeforeCompletion()：触发提交前同步回调完成
        activate AbstractPlatformTransactionManager #DarkSalmon
        deactivate AbstractPlatformTransactionManager

        alt 存在保存点
            note right of AbstractPlatformTransactionManager #aqua
                释放保存点，当前是嵌套事务，由外面的事务统一提交。
            end note

        else 新的事务
            AbstractPlatformTransactionManager -> DataSourceTransactionManager:doCommit()
            activate DataSourceTransactionManager #DarkSalmon

                DataSourceTransactionManager -> Connection : commit()
                activate Connection #DarkSalmon
                    note right of Connection #aqua
                        提交事务
                    end note
                Connection --> DataSourceTransactionManager
                deactivate Connection

            DataSourceTransactionManager --> AbstractPlatformTransactionManager
            deactivate DataSourceTransactionManager
        end

        alt 始终检查如果全局标记为回滚，则抛出异常
<-- AbstractPlatformTransactionManager : throw new UnexpectedRollbackException
        end

        AbstractPlatformTransactionManager -> AbstractPlatformTransactionManager : triggerAfterCommit()：触发提交后同步回调
        activate AbstractPlatformTransactionManager #DarkSalmon
        deactivate AbstractPlatformTransactionManager

        AbstractPlatformTransactionManager -> AbstractPlatformTransactionManager : triggerAfterCompletion()：触发提交后同步回调完成
        activate AbstractPlatformTransactionManager #DarkSalmon
        deactivate AbstractPlatformTransactionManager

        note right of AbstractPlatformTransactionManager #aqua
            1.标记已提交
            2.回复数据库连接原来的信息：自动提交标识
            3.解除线程绑定资源
            4.还原数据库连接之前的配置，释放连接
            5.还原因事务挂起的资源
        end note
        AbstractPlatformTransactionManager -> AbstractPlatformTransactionManager : cleanupAfterCompletion()：提交后资源清理
        activate AbstractPlatformTransactionManager #DarkSalmon

            AbstractPlatformTransactionManager -> DataSourceTransactionManager : doCleanupAfterCompletion()
            activate DataSourceTransactionManager #DarkSalmon

                DataSourceTransactionManager -> DataSourceUtils : resetConnectionAfterTransaction()
                activate DataSourceUtils #DarkSalmon
                DataSourceUtils --> DataSourceTransactionManager
                deactivate DataSourceUtils

                DataSourceTransactionManager -> DataSourceUtils : releaseConnection()
                activate DataSourceUtils #DarkSalmon
                DataSourceUtils --> DataSourceTransactionManager
                deactivate DataSourceUtils

            DataSourceTransactionManager --> AbstractPlatformTransactionManager
            deactivate DataSourceTransactionManager

        deactivate AbstractPlatformTransactionManager


    deactivate AbstractPlatformTransactionManager

<-- AbstractPlatformTransactionManager
deactivate AbstractPlatformTransactionManager

note right of AbstractPlatformTransactionManager #FAEBD7
    *总结
        1.真正提交前进行严格的检查，真正的提交还是交给了具体的实现类，运用了模板方法设计模式；
    备注：
        1.上述回滚描述篇幅略；
        2.具体数据库连接如何归还给连接池，由具体连接池实现方实现，Spring只是触发调用实现方；
end note

@enduml